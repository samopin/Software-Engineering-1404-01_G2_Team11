# سرویس امکانات و حمل‌ونقل (Facilities & Transportation)

**گروه Axiom — تیم ۱۳** — پیاده‌سازی فاز ۷ (مطابق P3, P5, P7).

این اپلیکیشن Django میکروسرویس **امکانات و حمل‌ونقل** را برای سامانه وب نقشه و جغرافیای ایران پیاده‌سازی می‌کند.

---

TEAM_APPS=team13
# کلیدهای نشان — ذخیره شده برای مرحلهٔ بعد

# NESHAN_API_KEY_SERVICE=service.4b8184b63cdb408b90a3a31feaabc6a8
# NESHAN_API_KEY_WEB=web.5ee1e82db9314ba5a50806d13018c9a1

با خواندن فایل ‌RUNA_AND_TEST کامند های مورد نظر پیدا میشوند

## قابلیت‌ها

- **مکان‌ها (POI):** هتل، رستوران، بیمارستان، موزه، تفریحی — با ترجمه فارسی/انگلیسی، آدرس و مختصات
- **رویدادها:** با تاریخ و مکان و ترجمه
- **نظرات و امتیاز:** نمایش و ثبت امتیاز (۱–۵) برای مکان و رویداد (فقط کاربران لاگین‌شده)
- **جزئیات تخصصی:** هتل (ستاره، بازه قیمت)، رستوران (نوع غذا، قیمت متوسط)، موزه (ساعت، بلیط)، امکانات هر مکان (PlaceAmenity)
- **مسیریابی و ETA:** فاصله و زمان رسیدن بین دو مکان (محاسبهٔ تقریبی Haversine از بک‌اند)، امکانات مبدأ و مقصد، ثبت مسیر برای کاربر لاگین‌شده. API نقشهٔ خارجی حذف شده؛ با API جدید قابل جایگزینی است.
- **حالت اضطراری:** نزدیک‌ترین مراکز امدادی (بیمارستان) به موقعیت کاربر
- **یکپارچه با Core:** نمایش وضعیت کاربر (ورود/خروج) در هدر و احراز هویت برای امتیاز و ثبت مسیر
- **نقشه:** برای بهبود سرعت، در لود اول نقشه تا **۲۰۰۰ نشان** (مکان) نمایش داده می‌شود؛ این نشان‌ها به‌نسبت از همهٔ انواع مکان (هتل، رستوران، بیمارستان، موزه، …) واکشی می‌شوند.

---

## پروژهٔ گروهی — عدم تغییر فولدرهای دیگر

برای فعالیت team13 **هیچ فایلی در app404، core یا سایر پوشه‌ها نیاز به تغییر ندارد.** مسیرها و تنظیمات از طریق `TEAM_APPS` در `.env` (یا مقدار پیش‌فرض settings) انجام می‌شود. جزئیات در **team13/INTEGRATION.md** آمده است.

---

## اجرای پروژه

از **ریشه پروژه** (پوشهٔ حاوی `manage.py`) با Python 3.11:

```bash
py -3.11 -m pip install -r requirements.txt
py -3.11 manage.py migrate
py -3.11 manage.py runserver
```

برای اجرای فقط تیم ۱۳، در `.env` (در ریشهٔ پروژه) مقدار `TEAM_APPS=team13` تنظیم شود. نمونه در **team13/env.example**.

سرویس از پیشوند `/team13/` در دسترس است:

- **صفحهٔ اصلی:** `http://localhost:8000/team13/`
- **مکان‌ها:** `http://localhost:8000/team13/places/` (فیلتر نوع و شهر)
- **جزئیات مکان:** `http://localhost:8000/team13/places/<place_id>/`
- **رویدادها:** `http://localhost:8000/team13/events/`
- **جزئیات رویداد:** `http://localhost:8000/team13/events/<event_id>/`
- **مسیریابی:** `http://localhost:8000/team13/routes/`
- **مراکز امدادی نزدیک:** `http://localhost:8000/team13/emergency/`
- **تست (نیاز به لاگین):** `http://localhost:8000/team13/ping/`

خروجی **JSON (API)** با اضافه کردن `?format=json` به هر یک از مسیرهای بالا یا با هدر `Accept: application/json` دریافت می‌شود.

---

## یکپارچه‌سازی با فاز ۵ و فاز ۷

- **فاز ۵ (دیتابیس):** همهٔ مدل‌ها با `app_label="team13"` و `db_table="team13_*"`؛ دیتابیس تیم با alias `team13` از طریق `core.db_router.TeamPerAppRouter` هدایت می‌شود. ویوها بدون `.using()` کار می‌کنند؛ اسکریپت‌های بارگذاری و export از `.using("team13")` استفاده می‌کنند.
- **فاز ۷ (پیاده‌سازی):** مسیرها، صفحات، نظرات/امتیاز، مسیریابی و ETA، حالت اضطراری، احراز هویت Core و UI/UX مطابق have_to_do تکمیل شده‌اند.
- **RouteLog:** `user_id` از نوع UUID و با `core.User.id` (UUID) سازگار است؛ در صورت لاگین کاربر، مسیر در دیتابیس team13 ثبت می‌شود.

---

## پایگاه داده

- **پیش‌فرض:** SQLite مخصوص تیم در `team13/team13.sqlite3`
- **دیتابیس ابری:** در `.env` متغیر `TEAM13_DATABASE_URL` را تنظیم کنید.

### بارگذاری دادهٔ نمونه

از ریشه پروژه (پیشنهادی — JSON از پوشهٔ **team13/temp_data_inseart**):

```bash
py -3.11 team13/load_temp_data.py --clear
```

پوشهٔ داده: **team13/temp_data_inseart** با فایل‌های `hotels.json`، `hospitals.json`، `restaurants.json`. در صورت نبود، اسکریپت به‌ترتیب ریشهٔ پروژه و **team13/temp_data** را هم بررسی می‌کند.

جایگزین (فقط CSV):

```bash
py -3.11 manage.py loaddata_team13_csv --clear
```

دادهٔ CSV در `team13/temp_data/*.csv` قرار دارد (طبق `team13/temp_data/README.md` در صورت وجود).

### بارگذاری دادهٔ موقعیت ایران (استان، شهر، روستا)

از ریشه پروژه:

```bash
py -3.11 team13/get_data/load_iran_location.py
```

با گزینهٔ روستاها (حجم زیاد):

```bash
py -3.11 team13/get_data/load_iran_location.py --with-villages
```

فایل‌های ورودی در `team13/get_data/iran_location/` (provinces.json, cities.json, villages.json) هستند. خروجی در دیتابیس و هم‌زمان در `team13/temp_data/` به‌روز می‌شود.

---

## یکپارچه‌سازی با احراز هویت Core

- وضعیت کاربر در **هدر تمام صفحات** team13 نمایش داده می‌شود (ورود / خروج / نام کاربر).
- **CORE_BASE_URL** در `.env`: اگر خالی باشد از `request.user` همین سرور استفاده می‌شود؛ اگر مقدار داشته باشد (مثلاً `http://localhost:8000`) وضعیت کاربر با فراخوانی `GET CORE_BASE_URL/api/auth/me/` و ارسال کوکی به‌دست می‌آید.
- **ثبت امتیاز** (مکان و رویداد) فقط برای کاربران لاگین‌شده؛ در غیر این صورت به صفحه ورود با پارامتر `next` هدایت می‌شوند.
- **ثبت مسیر** (RouteLog) فقط هنگام لاگین بودن کاربر انجام می‌شود.

---

## استانداردهای UI/UX (فاز ۷)

- **فونت:** Vazirmatn (بارگذاری از Google Fonts در قالب‌ها)
- **جهت:** راست‌به‌چپ (RTL)
- **پالت رنگی:** سبز جنگلی، سبز روشن، طلایی ایرانی، پس‌زمینه روشن (تعریف در `team13/static/team13/styles/style.css`)
- **ساختار:** هدر (وضعیت کاربر)، ناوبری یکسان، کارت‌ها و فرم‌های یکپارچه، فوتر در صفحات

---

## وابستگی‌های اضافی

وابستگی‌های اصلی پروژه در `requirements.txt` ریشهٔ پروژه هستند. برای اسکریپت‌های بارگذاری داده و فراخوانی Core پکیج **requests** استفاده می‌شود. در صورت نصب نبودن:

```bash
py -3.11 -m pip install requests
```

فایل `team13/requirements.txt` در صورت نیاز به وابستگی‌های اختصاصی این اپلیکیشن در همین پوشه قرار دارد.

---

## تحویل نهایی (فاز ۷)

- فایل zip با نام **P7_Axiom.zip** حاوی آخرین نسخهٔ کد (آخرین کامیت)
