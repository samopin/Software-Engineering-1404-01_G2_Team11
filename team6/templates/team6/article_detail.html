{% extends "team6/base.html" %}{% load notification_tags %}
{% block title %}{{ article.title_fa }}{% endblock %}

{% block content %}

<style>
    .article-content-body a {
        color: #0066cc !important; /* Ø¢Ø¨ÛŒ Ú©Ù„Ø§Ø³ÛŒÚ© ÙˆÛŒÚ©ÛŒ */
        text-decoration: underline !important; /* Ø²ÛŒØ±Ø®Ø·â€ŒØ¯Ø§Ø± */
        font-weight: 500;
    }
    .article-content-body a:hover {
        color: #004080 !important;
        background-color: rgba(0, 102, 204, 0.05);
    }
    .back-btn {
        margin-bottom: 15px;
    }
    .article-content-body {
        text-align: justify;
        background-color: #fff;
        line-height: 1.9;
        font-size: 1.15rem;
        border-right: 5px solid #4CAF50;
    }
    .ref-section-title {
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-top: 20px;
        color: #444;
        font-weight: bold;
    }
    .list-group-item-action:hover {
        background-color: #f8f9fa;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2>{{ article.title_fa }}
        {% if article.title_en %}
            <small class="text-muted">({{ article.title_en }})</small>
        {% endif %}
    </h2>
    
    <button onclick="history.back()" class="btn btn-outline-secondary btn-sm back-btn">
        <i class="fa-solid fa-arrow-left"></i> Ø¨Ø§Ø²Ú¯Ø´Øª
    </button>
</div>


<nav aria-label="breadcrumb">
    <ol class="breadcrumb bg-light p-2 rounded">
        <li class="breadcrumb-item">Ø¯Ø³ØªÙ‡ Ø¨Ù†Ø¯ÛŒ :</li>
        {% if article.category.parent %}
            <li class="breadcrumb-item"><a>{{ article.category.parent.title_fa }}</a></li>
        {% endif %}
        <li class="breadcrumb-item active">{{ article.category.title_fa }}</li>
    </ol>
</nav>
<div class="mb-3 text-muted">
    {% comment %} <i class="fa-solid fa-folder"></i> Ø¯Ø³ØªÙ‡: {{ article.category.title_fa }} |  {% endcomment %}
    <i class="fa-solid fa-eye"></i> Ø¨Ø§Ø²Ø¯ÛŒØ¯: {{ article.view_count|default:0 }} |
    <i class="fa-solid fa-calendar"></i> ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: {{ article.created_at|date:"Y/m/d" }}
</div>

<div class="card p-4 mb-4 article-content-body" id="article-body-container">
    {% if article.featured_image_url %}
        <div class="article-image-wrapper">
            <img src="{{ article.featured_image_url }}"
                 alt="{{ article.title_fa }}">
            <div class="image-caption">
                {{ article.title_fa }}
            </div>
        </div>
    {% endif %}
    {{ article.body_fa|safe|linebreaks }}
</div>
<div class="card shadow-sm mb-4 ref-card">
    <div class="card-body">
        <h5 class="ref-title"><i class="fa-solid fa-book-open me-2"></i> Ù…Ù†Ø§Ø¨Ø¹ØŒ Ù…Ø±Ø§Ø¬Ø¹ Ùˆ Ø¬Ø³ØªØ§Ø±Ù‡Ø§ÛŒ ÙˆØ§Ø¨Ø³ØªÙ‡</h5>
        
        <div class="row">
            <div class="col-md-6 border-start">
                <h6 class="small fw-bold text-primary"> Ù„ÛŒÙ†Ú© Ù‡Ø§ÛŒ Ø¯Ø§Ø®Ù„ÛŒ:</h6>
                <ul class="list-unstyled small">
                    {% for link in article.outgoing_links.all|slice:":5" %}
                        <li><i class="fa-solid fa-link text-muted me-1"></i> <a href="{% url 'team6:article_detail' link.to_article.slug %}">{{ link.to_article.title_fa }}</a></li>
                    {% empty %}
                        <li class="text-muted">Ù„ÛŒÙ†Ú© Ø¯Ø§Ø®Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-4 border-start">
                <h6 class="small fw-bold text-danger">Ù…Ù†Ø§Ø¨Ø¹ Ùˆ Ù…Ø±Ø§Ø¬Ø¹ Ø®Ø§Ø±Ø¬ÛŒ:</h6>
                <ul class="list-unstyled small">
                    {% for ref in article.wikiarticleref_set.all %}
                        <li>
                            <i class="fa-solid fa-external-link text-muted me-1"></i> 
                            <a href="{{ ref.url }}" target="_blank" title="{{ ref.publisher|default:'' }}">
                                {{ ref.title|truncatechars:40 }}
                            </a>
                        </li>
                    {% empty %}
                        <li class="text-muted">Ù…Ù†Ø¨Ø¹ Ø®Ø§Ø±Ø¬ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.</li>
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-6">
                <h6 class="small fw-bold text-success">Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡ Ø§Ø² Ù…ØªÙ†:</h6>
                <div id="extracted-refs-content" class="small text-muted" style="white-space: pre-line;">
                    <span class="text-italic"></span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="d-flex gap-2 mb-4">
    {% if request.user.is_authenticated and article.author_user_id == request.user.id %}
        <a href="{% url 'team6:article_edit' article.slug %}" class="btn btn-warning">
            <i class="fa-solid fa-edit"></i> ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ù‚Ø§Ù„Ù‡
        </a>
        <a href="{% url 'team6:article_delete' article.slug %}" class="btn btn-danger">
            <i class="fa fa-trash"></i> Ø­Ø°Ù Ù…Ù‚Ø§Ù„Ù‡
        </a>
    {% endif %}
    
    <a href="{% url 'team6:article_revisions' article.slug %}" class="btn btn-info">
        <i class="fa-solid fa-history"></i> ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§
    </a>
    
    <a href="{% url 'team6:article_report' article.slug %}" class="btn btn-outline-danger">
        <i class="fa-solid fa-flag"></i> Ú¯Ø²Ø§Ø±Ø´ ØªØ®Ù„Ù
    </a>
    
    {% if request.user.is_authenticated %}
        {% with is_following=article|is_user_following:request.user notify_status=article|get_notify_status:request.user %}
            
            {% if is_following %}
                <form method="POST" action="{% url 'team6:toggle_notify' article.slug %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn {% if notify_status %}btn-warning{% else %}btn-outline-success{% endif %}">
                        <i class="fa-solid fa-bell{% if not notify_status %}-slash{% endif %}"></i>
                        {% if notify_status %}
                            ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§
                        {% else %}
                            ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ø§Ø¹Ù„Ø§Ù†â€ŒÙ‡Ø§
                        {% endif %}
                    </button>
                </form>
                
                <form method="POST" action="{% url 'team6:article_follow' article.slug %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="unfollow">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fa-solid fa-user-minus"></i> Ù„ØºÙˆ Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù†
                    </button>
                </form>
                
            {% else %}
                <form method="POST" action="{% url 'team6:article_follow' article.slug %}" class="d-inline">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="follow">
                    <button type="submit" class="btn btn-outline-success">
                        <i class="fa-solid fa-user-plus"></i> Ø¯Ù†Ø¨Ø§Ù„ Ú©Ø±Ø¯Ù† Ù…Ù‚Ø§Ù„Ù‡
                    </button>
                </form>
            {% endif %}
            
        {% endwith %}
    {% endif %}
</div>

<hr class="my-4">

<div class="card shadow-sm">
    <div class="card-header bg-light">
        <i class="fa-solid fa-info-circle"></i> Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ
    </div>
    <div class="card-body">
        <p><strong>Ù†Ø§Ù… Ù…Ú©Ø§Ù†:</strong> {{ article.place_name|default:"Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡" }}</p>
        <p><strong>Ø®Ù„Ø§ØµÙ‡ (AI):</strong> <span class="text-muted">{{ article.summary|default:"Ø®Ù„Ø§ØµÙ‡â€ŒØ§ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª" }}</span></p>
        
        {% if article.tags.all %}
        <div class="mt-2">
            <strong>ğŸ·ï¸ ØªÚ¯â€ŒÙ‡Ø§:</strong>
            {% for tag in article.tags.all %}
                <span class="badge bg-light text-dark border me-1">{{ tag.title_fa }}</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <div class="mt-3 small text-muted">
            <p class="mb-1"><strong>Ø´Ù†Ø§Ø³Ù‡:</strong> {{ article.slug }}</p>
            <p class="mb-0"><strong>Ù„ÛŒÙ†Ú© Ù…Ø³ØªÙ‚ÛŒÙ…:</strong> <code>/team6/article/{{ article.slug }}/</code></p>
        </div>
    </div>
</div>
<style>
    .article-image-wrapper {
        float: none;               
        width: 100%;
        max-width: 500px;         
        margin: 0 auto 20px auto;
        border: 1px solid #e0e0e0;
        background: #fafafa;
        padding: 6px;
        border-radius: 10px;
        text-align: center;
    }

    .article-image-wrapper img {
        width: 100%;
        height: 320px;           
        object-fit: cover;     
        border-radius: 8px;
    }

    .image-caption {
        font-size: 0.85rem;
        color: #666;
        margin-top: 8px;
    }

    /* Ù…ÙˆØ¨Ø§ÛŒÙ„ */
    @media (max-width: 768px) {
        .article-image-wrapper {
            max-width: 100%;
        }

        .article-image-wrapper img {
            height: 240px;
        }
    }

</style>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        // Û±. Ú¯Ø±ÙØªÙ† Ø¸Ø±Ù Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§Ø±Ø³ÛŒ (Body_fa)
        const bodyContainer = document.getElementById('article-body-container');
        // Û². Ú¯Ø±ÙØªÙ† Ø¸Ø±Ù Ù…Ù‚ØµØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ù†Ø§Ø¨Ø¹
        const refsContent = document.getElementById('extracted-refs-content');
        const refsSection = document.getElementById('references-section');
        
        if (!bodyContainer || !refsContent) return;

        const fullHTML = bodyContainer.innerHTML;
        // Ø¬Ø¯Ø§ Ú©Ø±Ø¯Ù† Ø¨Ø®Ø´ Â«Ù…Ù†Ø§Ø¨Ø¹Â» Ø§Ø² Ø§Ù†ØªÙ‡Ø§ÛŒ Ù…ØªÙ† Ù…Ù‚Ø§Ù„Ù‡ Ùˆ Ù†Ù…Ø§ÛŒØ´ Ø¢Ù† Ø¯Ø± Ø¨Ø§Ú©Ø³ Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ (Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¢Ø®Ø±ÛŒÙ† Ø±Ø®Ø¯Ø§Ø¯ Ú©Ù„Ù…Ù‡ "Ù…Ù†Ø§Ø¨Ø¹").
        const keywords = ["Ù…Ù†Ø§Ø¨Ø¹"];
        let lastIndex = -1;

        // Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† Ø¢Ø®Ø±ÛŒÙ† Ú©Ù„Ù…Ù‡ "Ù…Ù†Ø§Ø¨Ø¹" Ø¯Ø± Ù…ØªÙ† ÙØ§Ø±Ø³ÛŒ
        keywords.forEach(word => {
            let index = fullHTML.lastIndexOf(word);
            if (index > lastIndex) {
                lastIndex = index;
            }
        });

        if (lastIndex !== -1) {
            // Ø¬Ø¯Ø§ Ø³Ø§Ø²ÛŒ Ù…ØªÙ†: Ø§Ø² Ø§Ø¨ØªØ¯Ø§ ØªØ§ Ù‚Ø¨Ù„ Ø§Ø² Ú©Ù„Ù…Ù‡ Ù…Ù†Ø§Ø¨Ø¹
            const cleanBody = fullHTML.substring(0, lastIndex);
            // Ø¬Ø¯Ø§ Ø³Ø§Ø²ÛŒ Ù…Ù†Ø§Ø¨Ø¹: Ø§Ø² Ú©Ù„Ù…Ù‡ Ù…Ù†Ø§Ø¨Ø¹ ØªØ§ Ø§Ù†ØªÙ‡Ø§ÛŒ Ù…ØªÙ†
            const extractedRefs = fullHTML.substring(lastIndex);

            // Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Ù…Ø­ØªÙˆØ§ Ø¯Ø± Ø¨Ø§Ø¯ÛŒ Ø§ØµÙ„ÛŒ
            bodyContainer.innerHTML = cleanBody;
            // Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù† Ù…Ù†Ø§Ø¨Ø¹ Ø¯Ø± Ø¨Ø®Ø´ Ù¾Ø§ÛŒÛŒÙ†ÛŒ
            refsContent.innerHTML = extractedRefs;
            // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù† Ú©Ù„ Ø¨Ø§Ú©Ø³ Ù…Ù†Ø§Ø¨Ø¹
            refsSection.style.display = 'block';
        }
    });
</script>

{% endblock %}