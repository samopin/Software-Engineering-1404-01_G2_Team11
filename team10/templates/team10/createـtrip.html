{% extends "team10/base.html" %}
{% load static %}

{% block title %}ایجاد برنامه سفر | ایران‌نما{% endblock %}

{% block extra_css %}
    <!-- تقویم شمسی -->
    <link rel="stylesheet" href="https://unpkg.com/persian-datepicker@latest/dist/css/persian-datepicker.min.css">
    <!-- استایل اختصاصی این صفحه -->
    <link rel="stylesheet" href="{% static 'team10/styles/create-trip.css' %}">
{% endblock %}

{% block content %}
    <section class="hero hero-custom">
        <div class="hero-content">
            <h2>برنامه‌ریزی سفر هوشمند</h2>
            <p>سفری شخصی‌سازی‌شده بر اساس علایق و سابقه شما</p>
        </div>
    </section>

    <main class="container dashboard">
        <div class="section-header">
            <h3>ایجاد سفر جدید</h3>
            <div class="line"></div>
        </div>

        <form id="create-trip-form" class="auth-card create-trip-card">
            <p class="form-section-label">اطلاعات اصلی سفر</p>

            <!-- مقصد -->
            <div class="form-group">
                <label for="destination">مقصد <span class="required">*</span></label>
                <div class="autocomplete-wrapper" id="destination-autocomplete">
                    <input type="text" id="destination" name="destination" placeholder="مثال: اصفهان، شیراز، کیش، مشهد..." required autocomplete="off" aria-autocomplete="list" aria-expanded="false" aria-controls="destination-suggestions">
                    <div id="destination-suggestions" class="autocomplete-panel" role="listbox" aria-label="پیشنهاد مقصد"></div>
                </div>
                <small class="field-hint">حداقل ۲ حرف وارد کنید تا پیشنهادها نمایش داده شوند.</small>
            </div>

            <!-- تاریخ‌ها -->
            <div class="form-row">
                <div class="form-group">
                    <label for="start-date">تاریخ شروع <span class="required">*</span></label>
                    <div class="t10-input-with-icon">
                        <input type="text" id="start-date" name="start_date_jalali" class="t10-jalali-input persian-date" placeholder="۱۴۰۴/۱۱/۲۲" required autocomplete="off">
                        <i class="fas fa-calendar-alt t10-calendar-icon"></i>
                    </div>
                    <input type="hidden" name="start_date" id="start-date-gregorian">
                </div>

                <div class="form-group">
                    <label for="end-date">تاریخ پایان <span class="required">*</span></label>
                    <div class="t10-input-with-icon">
                        <input type="text" id="end-date" name="end_date_jalali" class="t10-jalali-input persian-date" placeholder="۱۴۰۴/۱۲/۰۵" required autocomplete="off">
                        <i class="fas fa-calendar-alt t10-calendar-icon"></i>
                    </div>
                    <input type="hidden" name="end_date" id="end-date-gregorian">
                </div>
            </div>

            <div class="t10-inline-row">
                <!-- تعداد نفرات (بدون لیست: فقط عدد + دکمه کم/زیاد) -->
                <div class="form-group t10-inline-col">
                    <label for="travelers-input">تعداد مسافران</label>

                    <!-- ✅ فیلد واقعی که بک‌اند می‌گیرد (مخفی) -->
                    <select id="travelers" name="travelers_count" class="ui-hidden-control travelers-hidden-select" aria-hidden="true" tabindex="-1">
                        <!-- گزینه‌ها توسط JS ساخته می‌شوند (۱..۲۰) -->
                    </select>

                    <div class="t10-control-surface">
                        <div class="travelers-stepper travelers-stepper--premium" role="group" aria-label="کنترل تعداد مسافران">
                            <button type="button" class="stepper-btn stepper-btn--plus" id="travelers-plus" aria-label="افزایش تعداد مسافران" title="افزایش">
                                <i class="fa-solid fa-plus"></i>
                            </button>

                            <input
                                id="travelers-input"
                                class="stepper-input"
                                type="text"
                                inputmode="numeric"
                                pattern="[0-9۰-۹]*"
                                value="2"
                                aria-label="تعداد مسافران"
                                autocomplete="off"
                            >

                            <button type="button" class="stepper-btn stepper-btn--minus" id="travelers-minus" aria-label="کاهش تعداد مسافران" title="کاهش">
                                <i class="fa-solid fa-minus"></i>
                            </button>
                        </div>
                    </div>

                    <small id="travelers-hint" class="field-hint travelers-inline-hint" aria-live="polite">بین ۱ تا ۲۰ نفر</small>
                </div>

                <!-- سطح بودجه -->
                <div class="form-group t10-inline-col">
                    <label for="budget_level">سطح بودجه</label>
                    <select id="budget_level" name="budget_level" class="ui-hidden-control" aria-hidden="true" tabindex="-1">
                        <option value="ECONOMY">اقتصادی</option>
                        <option value="MODERATE" selected>متوسط</option>
                        <option value="LUXURY">لوکس</option>
                    </select>
                    <div class="t10-control-surface">
                        <div class="budget-segmented" role="group" aria-label="انتخاب سطح بودجه">
                            <button type="button" class="budget-pill" data-value="ECONOMY">اقتصادی</button>
                            <button type="button" class="budget-pill" data-value="MODERATE">متوسط</button>
                            <button type="button" class="budget-pill" data-value="LUXURY">لوکس</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- سبک و ترجیحات اصلی (چندگزینه‌ای) -->
            <div class="form-group">
                <p class="form-section-label form-section-label--inner">ترجیحات شخصی</p>
                <label>سبک سفر من (می‌توانید چند مورد انتخاب کنید)</label>
                <div class="chips-container">
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="nature"> طبیعت‌گردی
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="history"> تاریخی و فرهنگی
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="food"> غذاشناسی و رستوران‌گردی
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="relax"> آرامش و استراحت
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="adventure"> ماجراجویی و هیجانی
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="shopping"> خرید و بازارگردی
                    </label>
                    <label class="chip">
                        <input type="checkbox" name="preferences" value="nightlife"> تفریحات شبانه
                    </label>
                </div>
            </div>

            <!-- دکمه ارسال -->
            <div class="form-actions">
                <button type="submit" class="auth-btn btn-submit-signup" id="submit-btn">
                    <i class="fas fa-magic"></i> ساخت برنامه سفر هوشمند
                </button>
                <button type="button" class="t10-btn t10-btn--ghost" id="t10-reset-btn">
                    <i class="fa-solid fa-rotate-left"></i>
                    پاک کردن
                </button>
                <p class="loading-text" id="loading">
                    <i class="fas fa-spinner fa-spin"></i> در حال ساخت برنامه شخصی‌سازی‌شده...
                </p>
            </div>
        </form>

        <div id="result-area" class="result-area auth-card">
            <h2>برنامه سفر شما آماده است!</h2>
            <div id="t10-celebrate-badge" class="t10-celebrate-badge" aria-hidden="true"></div>
            <div id="result-content"></div>
            <button class="auth-btn btn-submit-login" onclick="window.location.reload()">سفر جدید</button>
        </div>
    </main>

    <!-- اسکریپت‌های مورد نیاز -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://unpkg.com/persian-date@latest/dist/persian-date.min.js"></script>
    <script src="https://unpkg.com/persian-datepicker@latest/dist/js/persian-datepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        // Convert Persian/Farsi numerals to English numerals
        function persianToEnglish(str) {
            const persianNumbers = ['۰', '۱', '۲', '۳', '۴', '۵', '۶', '۷', '۸', '۹'];
            const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
            let result = str;
            for (let i = 0; i < 10; i++) {
                result = result.replace(new RegExp(persianNumbers[i], 'g'), englishNumbers[i]);
            }
            return result;
        }

        // Jalali to Gregorian conversion algorithm
        // Based on Kazimierz M. Borkowski's algorithm
        function jalaliToGregorian(jy, jm, jd) {
            jy += 1595;
            let days = -355668 + (365 * jy) + (Math.floor(jy / 33) * 8) +
                       Math.floor(((jy % 33) + 3) / 4) + jd;

            if (jm < 7) {
                days += (jm - 1) * 31;
            } else {
                days += (jm - 7) * 30 + 186;
            }

            let gy = 400 * Math.floor(days / 146097);
            days %= 146097;

            let leap = true;
            if (days >= 36525) {
                days--;
                gy += 100 * Math.floor(days / 36524);
                days %= 36524;
                if (days >= 365) {
                    days++;
                }
                leap = false;
            }

            gy += 4 * Math.floor(days / 1461);
            days %= 1461;

            if (days >= 366) {
                leap = false;
                days--;
                gy += Math.floor(days / 365);
                days = days % 365;
            }

            let gm, gd;
            const sal_a = [0, 31, (leap || (gy % 100 !== 0 && gy % 4 === 0) || (gy % 400 === 0)) ? 29 : 28,
                          31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            gd = days + 1;
            for (gm = 0; gm < 13 && gd > sal_a[gm]; gm++) {
                gd -= sal_a[gm];
            }

            return { year: gy, month: gm, day: gd };
        }

        const LOCAL_IRAN_CITIES = [
            "تهران", "مشهد", "اصفهان", "شیراز", "تبریز", "کرج", "قم", "اهواز", "رشت", "کرمانشاه",
            "ارومیه", "زاهدان", "همدان", "یزد", "کرمان", "ساری", "گرگان", "قزوین", "اراک", "سنندج",
            "بندرعباس", "بوشهر", "کیش", "قشم", "کاشان", "نیشابور", "دزفول", "آبادان", "لاهیجان", "اردبیل",
            "زنجان", "خرم‌آباد", "یاسوج", "بیرجند", "سبزوار", "ملایر", "مراغه", "نجف‌آباد", "شاهین‌شهر", "اندیمشک"
        ];

        function toPersianDigits(value) {
            return String(value).replace(/\d/g, function(digit) {
                return "۰۱۲۳۴۵۶۷۸۹"[digit];
            });
        }

        function escapeHtml(raw) {
            return raw
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#39;");
        }

        function cityIconSvg(city) {
            const iconClass = "autocomplete-icon-svg";
            if (city === "تهران") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 3L9 10h2l-1.3 11L14 10h2L12 3z" fill="currentColor"/><circle cx="12" cy="2.5" r="1.2" fill="currentColor"/></svg>`;
            }
            if (city === "مشهد") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M8 20v-4h8v4" stroke="currentColor" stroke-width="1.8"/><path d="M7 16h10c0-3-2.2-5.5-5-5.5S7 13 7 16z" fill="none" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="8" r="1.1" fill="currentColor"/></svg>`;
            }
            if (city === "اصفهان") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 18h18" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M6 18c0-3.5 2.7-6.3 6-6.3s6 2.8 6 6.3" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M9 18v-2.5m6 2.5v-2.5" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>`;
            }
            if (city === "شیراز") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21v-7" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M12 8c1.8-3.2 6-2.8 6 0a3 3 0 0 1-3 3c-1.2 0-2.2-.6-3-1.8C11.2 10.4 10.2 11 9 11a3 3 0 0 1-3-3c0-2.8 4.2-3.2 6 0z" fill="none" stroke="currentColor" stroke-width="1.8"/></svg>`;
            }
            if (city === "کیش") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M11 20v-8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M11 12c1.5-2.2 3.8-3.2 6.3-2.8M11 10.5c1.4-1.9 3.4-3 5.8-3.2M11 13.5c1.3-1.4 3-2.1 4.9-2" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>`;
            }
            if (city === "تبریز") {
                return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20h16" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/><path d="M7 20v-6l5-3 5 3v6" fill="none" stroke="currentColor" stroke-width="1.8"/><path d="M12 7l3 2.2L12 11 9 9.2 12 7z" fill="currentColor"/></svg>`;
            }
            return `<svg class="${iconClass}" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 21s6-5.6 6-10a6 6 0 1 0-12 0c0 4.4 6 10 6 10z" fill="none" stroke="currentColor" stroke-width="1.8"/><circle cx="12" cy="11" r="2.2" fill="currentColor"/></svg>`;
        }

        function highlightMatch(city, query) {
            const start = city.indexOf(query);
            if (start === -1 || !query) {
                return escapeHtml(city);
            }
            const end = start + query.length;
            const before = escapeHtml(city.slice(0, start));
            const match = escapeHtml(city.slice(start, end));
            const after = escapeHtml(city.slice(end));
            return `${before}<mark>${match}</mark>${after}`;
        }

        function initDestinationAutocomplete() {
            const input = document.getElementById('destination');
            const wrapper = document.getElementById('destination-autocomplete');
            const panel = document.getElementById('destination-suggestions');
            if (!input || !wrapper || !panel) {
                return;
            }

            let filteredCities = [];
            let activeIndex = -1;

            function closePanel() {
                panel.classList.remove('is-open');
                input.setAttribute('aria-expanded', 'false');
                input.removeAttribute('aria-activedescendant');
                activeIndex = -1;
            }

            function openPanel() {
                panel.classList.add('is-open');
                input.setAttribute('aria-expanded', 'true');
            }

            function renderSuggestions(query) {
                if (query.length < 2) {
                    panel.innerHTML = '';
                    closePanel();
                    return;
                }

                filteredCities = LOCAL_IRAN_CITIES.filter(function(city) {
                    return city.includes(query);
                });

                if (filteredCities.length === 0) {
                    panel.innerHTML = `
                        <div class="autocomplete-empty">
                            ${cityIconSvg('')}
                            <span>نتیجه‌ای پیدا نشد</span>
                        </div>
                    `;
                    openPanel();
                    return;
                }

                panel.innerHTML = filteredCities.map(function(city, index) {
                    return `
                        <button type="button" class="autocomplete-item" role="option" id="destination-option-${index}" aria-selected="false" data-index="${index}" data-city="${escapeHtml(city)}">
                            <span class="autocomplete-icon">${cityIconSvg(city)}</span>
                            <span class="autocomplete-text">${highlightMatch(city, query)}</span>
                        </button>
                    `;
                }).join('');
                openPanel();
            }

            function setActive(index) {
                const items = panel.querySelectorAll('.autocomplete-item');
                if (!items.length) {
                    return;
                }
                items.forEach(function(item) {
                    item.classList.remove('is-active');
                    item.setAttribute('aria-selected', 'false');
                });
                const safeIndex = Math.max(0, Math.min(index, items.length - 1));
                const activeItem = items[safeIndex];
                activeItem.classList.add('is-active');
                activeItem.setAttribute('aria-selected', 'true');
                input.setAttribute('aria-activedescendant', activeItem.id);
                activeItem.scrollIntoView({ block: 'nearest' });
                activeIndex = safeIndex;
            }

            function selectCity(city) {
                input.value = city;
                closePanel();
            }

            input.addEventListener('input', function() {
                const query = input.value.trim();
                renderSuggestions(query);
            });

            input.addEventListener('keydown', function(event) {
                const items = panel.querySelectorAll('.autocomplete-item');
                if (!panel.classList.contains('is-open') || !items.length) {
                    if (event.key === 'ArrowDown' && input.value.trim().length >= 2) {
                        renderSuggestions(input.value.trim());
                    }
                    return;
                }

                if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    setActive(activeIndex + 1);
                } else if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    setActive(activeIndex <= 0 ? items.length - 1 : activeIndex - 1);
                } else if (event.key === 'Enter') {
                    if (activeIndex >= 0 && filteredCities[activeIndex]) {
                        event.preventDefault();
                        selectCity(filteredCities[activeIndex]);
                    }
                } else if (event.key === 'Escape') {
                    closePanel();
                }
            });

            panel.addEventListener('mousedown', function(event) {
                event.preventDefault();
            });

            panel.addEventListener('click', function(event) {
                const row = event.target.closest('.autocomplete-item');
                if (!row) {
                    return;
                }
                const city = row.getAttribute('data-city');
                if (city) {
                    selectCity(city);
                }
            });

            document.addEventListener('click', function(event) {
                if (!wrapper.contains(event.target)) {
                    closePanel();
                }
            });
        }

        function initTravelersStepper() {
            const travelersSelect = document.getElementById('travelers');
            const travelersInput = document.getElementById('travelers-input');
            const travelersHint = document.getElementById('travelers-hint');
            const plusBtn = document.getElementById('travelers-plus');
            const minusBtn = document.getElementById('travelers-minus');
            if (!travelersSelect || !travelersInput || !travelersHint || !plusBtn || !minusBtn) {
                return;
            }

            const minTravelers = 1;
            const maxTravelers = 20;

            // build real select options (1..20) - backend receives travelers_count
            travelersSelect.innerHTML = '';
            for (let i = minTravelers; i <= maxTravelers; i++) {
                const option = document.createElement('option');
                option.value = String(i);
                option.textContent = i === 1 ? `${toPersianDigits(i)} نفر (تنها)` : `${toPersianDigits(i)} نفر`;
                travelersSelect.appendChild(option);
            }

            const defaultHint = `بین ${toPersianDigits(minTravelers)} تا ${toPersianDigits(maxTravelers)} نفر`;
            const minWarning = `حداقل ${toPersianDigits(minTravelers)} نفر`;
            const maxWarning = "حداکثر ۲۰ نفر";

            function clamp(n) {
                return Math.max(minTravelers, Math.min(n, maxTravelers));
            }

            function setHint(message, isWarning) {
                travelersHint.textContent = message || defaultHint;
                travelersHint.classList.toggle('is-warning', Boolean(isWarning));
            }

            // initial value (use 2 by default)
            let travelersCount = 2;

            function syncTravelers() {
                travelersSelect.value = String(travelersCount);
                travelersInput.value = toPersianDigits(travelersCount);
            }

            function normalizeDigits(raw) {
                return persianToEnglish(String(raw || '')).replace(/[^\d]/g, '');
            }

            function parseTypedValue(raw) {
                const normalized = normalizeDigits(raw);
                if (!normalized) return null;
                const parsed = parseInt(normalized, 10);
                return Number.isFinite(parsed) ? parsed : null;
            }

            function increaseTravelers() {
                if (travelersCount >= maxTravelers) {
                    setHint(maxWarning, true);
                    syncTravelers();
                    return;
                }
                travelersCount += 1;
                syncTravelers();
                setHint();
            }

            function decreaseTravelers() {
                if (travelersCount <= minTravelers) {
                    setHint(minWarning, true);
                    syncTravelers();
                    return;
                }
                travelersCount -= 1;
                syncTravelers();
                setHint();
            }

            plusBtn.addEventListener('click', increaseTravelers);
            minusBtn.addEventListener('click', decreaseTravelers);

            travelersInput.addEventListener('input', function() {
                const normalized = normalizeDigits(travelersInput.value);
                travelersInput.value = normalized ? toPersianDigits(normalized) : '';
                const typed = parseTypedValue(normalized);
                if (typed === null) {
                    return;
                }

                const clamped = clamp(typed);
                travelersCount = clamped;
                syncTravelers();

                if (typed > maxTravelers) {
                    setHint(maxWarning, true);
                } else if (typed < minTravelers) {
                    setHint(minWarning, true);
                } else {
                    setHint();
                }
            });

            travelersInput.addEventListener('blur', function() {
                const typed = parseTypedValue(travelersInput.value);
                travelersCount = clamp(typed === null ? travelersCount : typed);
                syncTravelers();
                if (travelersCount > minTravelers && travelersCount < maxTravelers) {
                    setHint();
                }
            });

            travelersInput.addEventListener('keydown', function(event) {
                if (event.key === 'ArrowUp') {
                    event.preventDefault();
                    increaseTravelers();
                } else if (event.key === 'ArrowDown') {
                    event.preventDefault();
                    decreaseTravelers();
                } else if (event.key === 'Enter') {
                    const typed = parseTypedValue(travelersInput.value);
                    travelersCount = clamp(typed === null ? travelersCount : typed);
                    syncTravelers();
                    if (typed !== null && typed > maxTravelers) {
                        setHint(maxWarning, true);
                    } else if (typed !== null && typed < minTravelers) {
                        setHint(minWarning, true);
                    } else {
                        setHint();
                    }
                }
            });

            // init
            syncTravelers();
            setHint();

            window.t10SetTravelersCount = function(nextValue) {
                const next = parseInt(nextValue, 10);
                travelersCount = clamp(Number.isFinite(next) ? next : travelersCount);
                syncTravelers();
                setHint();
            };
            window.t10ResetTravelersHint = function() {
                setHint();
            };
        }

        function initBudgetSegmentedControl() {
            const budgetSelect = document.getElementById('budget_level');
            const pills = document.querySelectorAll('.budget-pill');
            if (!budgetSelect || !pills.length) {
                return;
            }

            function syncBudgetPills() {
                pills.forEach(function(pill) {
                    const isActive = pill.getAttribute('data-value') === budgetSelect.value;
                    pill.classList.toggle('is-active', isActive);
                    pill.setAttribute('aria-pressed', isActive ? 'true' : 'false');
                });
            }

            function setBudget(value) {
                budgetSelect.value = value;
                syncBudgetPills();
            }

            pills.forEach(function(pill) {
                pill.addEventListener('click', function() {
                    setBudget(pill.getAttribute('data-value'));
                });
            });

            syncBudgetPills();
            window.t10SetBudgetValue = setBudget;
        }

        $(document).ready(function() {
            const datePickerOptions = {
                observer: true,
                format: 'YYYY/MM/DD',
                autoClose: true,
                initialValue: false,
                toolbox: {
                    calendarSwitch: { enabled: false }
                },
                timePicker: { enabled: false },
                onSelect: function(unix) {
                    let jalaliStr = persianToEnglish($(this._targetInput).val());
                    let parts = jalaliStr.split('/');

                    if (parts.length === 3) {
                        let jy = parseInt(parts[0]);
                        let jm = parseInt(parts[1]);
                        let jd = parseInt(parts[2]);

                        let greg = jalaliToGregorian(jy, jm, jd);
                        let gDate = greg.year + '-' +
                                    ('0' + greg.month).slice(-2) + '-' +
                                    ('0' + greg.day).slice(-2);

                        if (this._targetInput.id === 'start-date') {
                            $('#start-date-gregorian').val(gDate);
                        } else if (this._targetInput.id === 'end-date') {
                            $('#end-date-gregorian').val(gDate);
                        }

                        console.log('Converted:', jalaliStr, '→', gDate);
                    }
                }
            };

            $('#start-date').persianDatepicker(datePickerOptions);
            $('#end-date').persianDatepicker(datePickerOptions);

            $('.t10-jalali-input').on('focus', function() {
                $(this).persianDatepicker('show');
            });

            $('.t10-calendar-icon').on('click', function() {
                $(this).siblings('.t10-jalali-input').focus();
            });

            $('#start-date').on('change', function() {
                let startVal = $(this).val();
                if (startVal) {
                    $('#end-date').persianDatepicker('option', 'minDate', startVal);
                }
            });

            $('.t10-jalali-input').on('keydown', function(e) {
                // allow typing
            });

            initDestinationAutocomplete();
            initTravelersStepper();
            initBudgetSegmentedControl();
        });

        const form = document.getElementById('create-trip-form');
        const loading = document.getElementById('loading');
        const resultArea = document.getElementById('result-area');
        const resultContent = document.getElementById('result-content');
        const celebrateBadge = document.getElementById('t10-celebrate-badge');
        const submitBtn = document.getElementById('submit-btn');
        const resetBtn = document.getElementById('t10-reset-btn');

        const DEFAULT_TRAVELERS = (function() {
            const travelersInput = document.getElementById('travelers-input');
            const raw = travelersInput ? persianToEnglish(travelersInput.value) : '2';
            const parsed = parseInt(raw, 10);
            return Number.isFinite(parsed) ? parsed : 2;
        })();

        const DEFAULT_BUDGET = (function() {
            const budgetSelect = document.getElementById('budget_level');
            return budgetSelect ? budgetSelect.value : 'MODERATE';
        })();

        loading.style.display = 'none';
        resultArea.style.display = 'none';

        function runConfetti() {
            if (window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                return;
            }
            if (typeof window.confetti !== 'function') {
                return;
            }

            const defaults = {
                startVelocity: 28,
                ticks: 120,
                gravity: 1.1,
                scalar: 0.95,
                zIndex: 1200,
                colors: ['#22c55e', '#26c6da', '#eab308', '#f97316', '#60a5fa']
            };

            const bursts = [
                { particleCount: 40, spread: 68, angle: 120, origin: { x: 0.12, y: 0.65 } },
                { particleCount: 40, spread: 68, angle: 60, origin: { x: 0.88, y: 0.65 } },
                { particleCount: 52, spread: 86, angle: 90, origin: { x: 0.5, y: 0.5 } },
                { particleCount: 34, spread: 58, angle: 100, origin: { x: 0.32, y: 0.36 } },
                { particleCount: 34, spread: 58, angle: 80, origin: { x: 0.68, y: 0.36 } }
            ];

            bursts.forEach(function(config, index) {
                window.setTimeout(function() {
                    window.confetti(Object.assign({}, defaults, config));
                }, index * 300);
            });
        }

        function showCelebrateBadge() {
            if (!celebrateBadge) {
                return;
            }
            celebrateBadge.textContent = '🧳✨';
            celebrateBadge.classList.remove('is-visible', 'is-animating');
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                celebrateBadge.classList.add('is-animating');
            }
            celebrateBadge.classList.add('is-visible');

            window.setTimeout(function() {
                celebrateBadge.classList.remove('is-animating');
            }, 1500);
        }

        function clearSelectedPrefs() {
            document.querySelectorAll('input[name="preferences"]').forEach(function(input) {
                input.checked = false;
            });
        }

        function resetCreateTripForm() {
            const destinationInput = document.getElementById('destination');
            const destinationPanel = document.getElementById('destination-suggestions');
            const startDateInput = document.getElementById('start-date');
            const endDateInput = document.getElementById('end-date');
            const startDateGreg = document.getElementById('start-date-gregorian');
            const endDateGreg = document.getElementById('end-date-gregorian');

            if (destinationInput) {
                destinationInput.value = '';
                destinationInput.focus();
            }
            if (destinationPanel) {
                destinationPanel.innerHTML = '';
                destinationPanel.classList.remove('is-open');
            }

            if (startDateInput) startDateInput.value = '';
            if (endDateInput) endDateInput.value = '';
            if (startDateGreg) startDateGreg.value = '';
            if (endDateGreg) endDateGreg.value = '';

            try { $('#start-date').persianDatepicker('setDate', null); } catch (err) {}
            try { $('#end-date').persianDatepicker('setDate', null); } catch (err) {}
            try { $('#end-date').persianDatepicker('option', 'minDate', null); } catch (err) {}

            if (typeof window.t10SetTravelersCount === 'function') {
                window.t10SetTravelersCount(DEFAULT_TRAVELERS);
            }
            if (typeof window.t10ResetTravelersHint === 'function') {
                window.t10ResetTravelersHint();
            }

            if (typeof window.t10SetBudgetValue === 'function') {
                window.t10SetBudgetValue(DEFAULT_BUDGET);
            }

            clearSelectedPrefs();

            if (loading) loading.style.display = 'none';
            if (resultArea) resultArea.style.display = 'none';
            if (resultContent) resultContent.innerHTML = '';
            if (celebrateBadge) {
                celebrateBadge.textContent = '';
                celebrateBadge.classList.remove('is-visible', 'is-animating');
            }

            if (form) {
                form.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        if (resetBtn) {
            resetBtn.addEventListener('click', resetCreateTripForm);
        }

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            submitBtn.disabled = true;
            loading.style.display = 'block';
            resultArea.style.display = 'none';

            const formData = new FormData(form);
            const data = Object.fromEntries(formData);

            data.preferences = formData.getAll('preferences');

            let startGreg = $('#start-date-gregorian').val();
            let endGreg = $('#end-date-gregorian').val();

            if (!startGreg || !endGreg) {
                let startJalali = persianToEnglish($('#start-date').val());
                let endJalali = persianToEnglish($('#end-date').val());

                if (startJalali && endJalali) {
                    try {
                        let startParts = startJalali.split('/');
                        if (startParts.length === 3) {
                            let startConv = jalaliToGregorian(
                                parseInt(startParts[0]),
                                parseInt(startParts[1]),
                                parseInt(startParts[2])
                            );
                            startGreg = `${startConv.year}-${('0' + startConv.month).slice(-2)}-${('0' + startConv.day).slice(-2)}`;
                        }

                        let endParts = endJalali.split('/');
                        if (endParts.length === 3) {
                            let endConv = jalaliToGregorian(
                                parseInt(endParts[0]),
                                parseInt(endParts[1]),
                                parseInt(endParts[2])
                            );
                            endGreg = `${endConv.year}-${('0' + endConv.month).slice(-2)}-${('0' + endConv.day).slice(-2)}`;
                        }
                    } catch (err) {
                        console.error('Manual conversion error:', err);
                    }
                }
            }

            if (!startGreg || !endGreg) {
                resultContent.innerHTML = `<p class="error-message">لطفاً تاریخ‌ها را وارد کنید</p>`;
                loading.style.display = 'none';
                resultArea.style.display = 'block';
                submitBtn.disabled = false;
                return;
            }

            data.start_date = `${startGreg}T00:00:00`;
            data.end_date = `${endGreg}T23:59:59`;
            console.log('Final dates:', { start: data.start_date, end: data.end_date });

            try {
                const response = await fetch('/team10/api/trips/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    const hasTripId = Boolean(result.trip_id);
                    resultContent.innerHTML = `
                        <p class="success-message">سفر با موفقیت ایجاد شد!</p>
                        <p>شناسه سفر: <strong>${result.trip_id || '—'}</strong></p>
                        <p>وضعیت: ${result.status === 'DRAFT' ? 'پیش‌نویس' : result.status}</p>
                        <button class="btn btn-login" onclick="goToTripDetails(${result.trip_id || 'null'})" ${hasTripId ? '' : 'disabled'}>مشاهده برنامه سفر</button>
                        ${hasTripId ? '' : '<p class="error-message">شناسه سفر دریافت نشد</p>'}
                    `;
                    runConfetti();
                    showCelebrateBadge();
                } else {
                    if (celebrateBadge) {
                        celebrateBadge.classList.remove('is-visible', 'is-animating');
                    }
                    resultContent.innerHTML = `<p class="error-message">خطا: ${result.error || 'مشکلی پیش آمد'}</p>`;
                }
            } catch (err) {
                if (celebrateBadge) {
                    celebrateBadge.classList.remove('is-visible', 'is-animating');
                }
                resultContent.innerHTML = `<p class="error-message">اتصال به سرور برقرار نشد</p>`;
            } finally {
                loading.style.display = 'none';
                resultArea.style.display = 'block';
                submitBtn.disabled = false;
            }
        });

        function goToTripDetails(tripId) {
            if (!tripId) return;
            window.location.assign(`/team10/trips/${tripId}/`);
        }
    </script>
{% endblock %}

{% block extra_js %}
{% endblock %}
